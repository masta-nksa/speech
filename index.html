<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lernprogramm</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            text-align: center;
            padding: 20px;
        }

        h1,
        h2 {
            color: #333;
        }

        button {
            font-size: 18px;
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #87CEEB;
        }

        .option-btn {
            background-color: #4682B4;
            color: white;
            width: 170px;
        }

        .hidden {
            display: none;
        }

        .home-icon {
            position: absolute;
            top: 20px;
            left: 20px;
            cursor: pointer;
        }

        .error {
            border: 2px solid red;
            background-color: red;
        }

        .home-icon img {
            width: 40px;
            height: 40px;
        }

        .quiz-container {
            margin-top: 50px;
        }

        .word-display {
            font-size: 36px;
            margin: 40px 0;
        }

        .options {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .scoreboard {
            font-size: 20px;
            margin-top: 20px;
        }

        #input-field {
            font-size: 20px;
            padding: 10px;
            margin-top: 20px;
            width: 300px;
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="home-icon" onclick="goToHome()">
        <img src="https://img.icons8.com/ios-filled/50/000000/home.png" alt="Home">
    </div>

    <h1 id="headerText">Choose a csv-file.</h1>

    <div id="csv-upload-section">
        <h2>csv-fileupload</h2>
        <input type="file" id="csvFileInput" accept=".csv" onchange="loadCSVFile(event)">
    </div>

    <div id="lesson-selection-section" class="hidden">
        <h2>lessons:</h2>
        <div id="lesson-selection" class="lesson-selection"></div>
        <button class="option-btn" onclick="startQuiz()">terms</button>
        <button class="option-btn" onclick="startLearning()">spelling</button>
        <button class="option-btn" onclick="startWriting()">writing</button>
    </div>

    <div id="quiz-section" class="hidden">
        <h2>find the term</h2>
        <div class="quiz-container">
            <div id="word-display" class="word-display"></div>
            <div id="options" class="options"></div>
        </div>
    </div>

    <div id="learning-section" class="hidden">
        <h2>leaning</h2>
        <div class="quiz-container">
            <div id="german-word-display" class="word-display"></div>
            <div id="learning-options" class="options"></div>
        </div>
    </div>

    <div id="writing-section" class="hidden">
        <h2>writing</h2>
        <div class="quiz-container">
            <div id="german-word-writing" class="word-display"></div>
            <input type="text" id="input-field" placeholder="Englische Übersetzung eingeben"
                onkeydown="if (event.key === 'Enter') { event.preventDefault(); checkInput(); }">
            <button class="option-btn" onclick="checkInput()">Überprüfen</button>
        </div>
    </div>
    <div id="scoreboard" class="scoreboard"></div>

    <script>
        let data = [];
        let selectedLessons = [];
        let currentDataset = [];
        let currentIndex = 0;
        let correctAnswersCount = 0;
        let wrongAnswersCount = 0;
        let wrongAnswersLearningCount = 0;
        window.addEventListener("DOMContentLoaded", loadDefaultCSV);

        function loadDefaultCSV() {
            fetch("lessons.csv")
                .then(response => {
                    if (!response.ok) throw new Error("Standard-CSV-Datei konnte nicht geladen werden.");
                    return response.text();
                })
                .then(text => {
                    data = parseCSV(text);
                    showLessonSelection();
                })
                .catch(error => console.error(error.message));
        }

        function loadCSVFile(event) {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            const reader = new FileReader();

            if (!file) {
                alert('Choose a csv-file.');
                return;
            }

            reader.onload = (e) => {
                data = parseCSV(e.target.result);
                showLessonSelection();
            };

            reader.readAsText(file);
        }

        function parseCSV(text) {
            return text.trim().split('\n').slice(1).map(row => {
                const [Lesson, English, Deutsch] = row.split(';');
                return { Lesson, English, Deutsch };
            });
        }

        function showLessonSelection() {
            document.getElementById('csv-upload-section').classList.add('hidden');
            document.getElementById('lesson-selection-section').classList.remove('hidden');
            const lessons = [...new Set(data.map(item => item.Lesson))];
            displayLessonSelection(lessons);
            document.getElementById('headerText').innerText = 'First: choose lessons, second choose a mode';
        }

        function displayLessonSelection(lessons) {
            const lessonSelectionDiv = document.getElementById('lesson-selection');
            lessonSelectionDiv.innerHTML = '';

            lessons.forEach(lesson => {
                lessonSelectionDiv.innerHTML += `
                    <input type="checkbox" value="${lesson}" id="${lesson}">
                    <label for="${lesson}">${lesson}</label><br>
                `;
            });
        }

        function hideHeaderText() {
            document.getElementById('headerText').classList.add('hidden');
        }

        function startQuiz() {
            hideHeaderText();
            setupQuiz('quiz-section');
        }

        function startLearning() {
            hideHeaderText();
            setupQuiz('learning-section');
        }

        function startWriting() {
            hideHeaderText();
            setupQuiz('writing-section');
        }

        function setupQuiz(section) {
            selectedLessons = Array.from(document.querySelectorAll('#lesson-selection input:checked'))
                .map(checkbox => checkbox.value);
            currentDataset = data.filter(item => selectedLessons.includes(item.Lesson));

            if (currentDataset.length > 0) {
                document.getElementById('lesson-selection-section').classList.add('hidden');
                document.getElementById(section).classList.remove('hidden');
                currentIndex = 0;
                correctAnswersCount = 0;
                wrongAnswersCount = 0;
                wrongAnswersLearningCount = 0;

                if (section === 'quiz-section') {
                    showNextWord();
                } else if (section === 'learning-section') {
                    showNextLearningWord();
                } else if (section === 'writing-section') {
                    showNextWritingWord();
                }
            } else {
                alert('Bitte wähle mindestens eine Lektion aus.');
            }
        }

        function generateVariations(correctAnswer) {
            const variations = [];
            const letters = correctAnswer.split('');

            // Variation 1: Remove a random letter
            const variation1 = correctAnswer.slice(0, Math.floor(Math.random() * letters.length)) + correctAnswer.slice(Math.floor(Math.random() * letters.length) + 1);
            variations.push(variation1);

            // Variation 2: Swap two adjacent letters
            const index = Math.floor(Math.random() * (letters.length - 1));
            const variation2 = letters.slice();
            [variation2[index], variation2[index + 1]] = [variation2[index + 1], variation2[index]];
            variations.push(variation2.join(''));

            // Variation 3: Füge einen zusätzlichen zufälligen Kleinbuchstaben an einer zufälligen Stelle im Wort ein
            const randomLetter = String.fromCharCode(97 + Math.floor(Math.random() * 26));
            const insertPosition = Math.floor(Math.random() * (correctAnswer.length + 1)); // Stelle bestimmen
            const variation3 = correctAnswer.slice(0, insertPosition) + randomLetter + correctAnswer.slice(insertPosition);
            variations.push(variation3);

            return variations;
        }


        function showNextWord() {
            if (currentIndex >= currentDataset.length) {
                alert(`Quiz beendet! Richtig: ${correctAnswersCount}, Falsch: ${wrongAnswersCount}`);
                return;
            }

            const currentWord = currentDataset[currentIndex];
            document.getElementById('word-display').innerText = currentWord.English;
            speakText(currentWord.English);

            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            const allOptions = shuffleArray([currentWord.Deutsch, ...getRandomWrongAnswers(currentWord.Deutsch)]);
            allOptions.forEach(option => createOptionButton(option, currentWord.Deutsch, optionsDiv));

            updateScoreboard();
        }

        function createOptionButton(option, correctAnswer, optionsDiv) {
            const btn = document.createElement('button');
            btn.classList.add('option-btn');
            btn.innerText = option;
            btn.onclick = () => {
                option === correctAnswer ? correctAnswersCount++ : wrongAnswersCount++;
                currentIndex++;
                updateScoreboard();
                showNextWord();
            };
            optionsDiv.appendChild(btn);
        }

        function getRandomWrongAnswers(correctAnswer) {
            const wrongAnswers = data.filter(item => item.Deutsch !== correctAnswer).map(item => item.Deutsch);
            return shuffleArray(wrongAnswers).slice(0, 3);
        }

        function showNextWritingWord() {
            if (currentIndex >= currentDataset.length) {
                alert(`Schreiben beendet! Richtig: ${correctAnswersCount}, Falsch: ${wrongAnswersCount}`);
                return;
            }

            const currentWord = currentDataset[currentIndex];
            document.getElementById('german-word-writing').innerText = currentWord.Deutsch;
            document.getElementById('input-field').value = '';
            updateScoreboard();
        }

        let attemptCount = 0; // Zähler für Fehlversuche

        function checkInput() {
            const inputField = document.getElementById('input-field');
            const input = inputField.value.trim();
            const correctAnswer = currentDataset[currentIndex].English;

            if (input === correctAnswer) {
                correctAnswersCount++;
                attemptCount = 0; // Zurücksetzen bei richtiger Antwort
                currentIndex++;
                inputField.classList.remove('error')
                showNextWritingWord();
            } else {
                wrongAnswersCount++;
                attemptCount++;

                // Rahmen rot aufleuchten lassen
                inputField.classList.add('error');
                setTimeout(() => inputField.classList.remove('error'), 500);
                if (attemptCount >= 2) {
                    inputField.value = correctAnswer; // Korrekte Antwort anzeigen
                    attemptCount = 0; // Zurücksetzen für das nächste Wort
                    currentIndex++;
                    setTimeout(showNextWritingWord, 2000); // Weiter nach 2 Sekunden
                }
            }
        }




        function showNextLearningWord() {
            if (currentIndex >= currentDataset.length) {
                alert(`Lernen beendet! Richtig: ${correctAnswersCount}, Falsch: ${wrongAnswersCount}, Falsch im Lernen: ${wrongAnswersLearningCount}`);
                return;
            }

            const currentWord = currentDataset[currentIndex];
            const germanWordDisplay = document.getElementById('german-word-display');
            germanWordDisplay.innerText = currentWord.Deutsch;

            const correctAnswer = currentWord.English;
            const variations = generateVariations(correctAnswer);

            const optionsDiv = document.getElementById('learning-options');
            optionsDiv.innerHTML = '';

            const allOptions = [correctAnswer, ...variations];
            shuffleArray(allOptions);

            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.classList.add('option-btn');
                btn.innerText = option;
                btn.onclick = function () {
                    speakText(option);
                    if (option === correctAnswer) {
                        currentIndex++;
                        correctAnswersCount++
                        updateScoreboard();
                        showNextLearningWord();

                    } else {
                        wrongAnswersCount++;
                        updateScoreboard();
                    }
                };
                optionsDiv.appendChild(btn);
            });

            updateScoreboard();
        }


        function updateScoreboard() {
            document.getElementById('scoreboard').innerText = `correct: ${correctAnswersCount} | false: ${wrongAnswersCount} | remaining questions: ${currentDataset.length - currentIndex}`;
        }
        function clearScoreboard() {
            document.getElementById('scoreboard').innerText = ``;
        }


        function speakText(text) {
            const speech = new SpeechSynthesisUtterance();
            speech.lang = 'en-US'; // Sprache einstellen
            speech.text = text;
            speech.onerror = (event) => console.error("Fehler beim Sprechen:", event);
            speechSynthesis.cancel(); // Alle laufenden Ausgaben stoppen
            speechSynthesis.speak(speech);
        }

        function shuffleArray(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        function goToHome() {
            // Blende alle anderen Abschnitte aus
            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('learning-section').classList.add('hidden');
            document.getElementById('writing-section').classList.add('hidden');

            document.getElementById('lesson-selection-section').classList.remove('hidden');

            // Zeige den CSV-Upload-Bereich und den Header-Text an
            document.getElementById('csv-upload-section').classList.remove('hidden');
            clearScoreboard();
        }
    </script>

</body>

</html>